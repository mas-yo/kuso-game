<!DOCTYPE html>
<html>
<head>
    <title>kuso-game</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #f0f0f0; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #gameCanvas { 
            background-image: url('./images/room.png'); /* 部屋の画像 */
            background-size: cover;
            cursor: pointer;
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 画像のURL
        const playerImageURL = './images/player.png'; // プレイヤーの画像
        const dogImageURL = './images/moco.png'; // 犬の画像
        const poopImageURL = './images/poop.png'; // フンの画像

        // 画像オブジェクト
        const playerImage = new Image();
        const dogImage = new Image();
        const poopImage = new Image();

        // ゲームのパラメータ
        const roomWidth = 600;
        const roomHeight = 400;
        const playerSize = 50; // 画像サイズに合わせて調整
        const dogSize = 40; // 画像サイズに合わせて調整
        const poopSize = 30; // 画像サイズに合わせて調整
        let playerX = roomWidth / 2;
        let playerY = roomHeight / 2;
        let targetX = playerX;
        let targetY = playerY;
        const playerSpeed = 3;
        let dogX = Math.random() * roomWidth;
        let dogY = Math.random() * roomHeight;
        // 犬の速度を一定の大きさで、方向だけランダムにする
        const dogSpeedMagnitude = 1.5; // 速度の大きさを一定に
        const dogAngle = Math.random() * 2 * Math.PI; // ランダムな角度
        let dogSpeedX = Math.cos(dogAngle) * dogSpeedMagnitude;
        let dogSpeedY = Math.sin(dogAngle) * dogSpeedMagnitude;
        const poops = [];
        let score = 0; // スコア変数
        let lastSpeedIncrease = 0; // 最後にスピードを上げたスコアのマイルストーン

        // キャンバスのサイズを設定
        canvas.width = roomWidth;
        canvas.height = roomHeight;

        // キャンバスをブラウザサイズに合わせてスケーリング
        function scaleCanvas() {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // アスペクト比を維持しながらスケーリング
            const scaleX = windowWidth / roomWidth;
            const scaleY = windowHeight / roomHeight;
            const scale = Math.min(scaleX, scaleY);
            
            canvas.style.width = (roomWidth * scale) + 'px';
            canvas.style.height = (roomHeight * scale) + 'px';
        }

        // 初期スケーリング
        scaleCanvas();

        // ウィンドウリサイズ時にスケーリングを更新
        window.addEventListener('resize', scaleCanvas);

        // プレイヤーを描画する関数
        function drawPlayer() {
            ctx.drawImage(playerImage, playerX - playerSize / 2, playerY - playerSize / 2, playerSize, playerSize);
        }

        // 犬を描画する関数
        function drawDog() {
            ctx.drawImage(dogImage, dogX - dogSize / 2, dogY - dogSize / 2, dogSize, dogSize);
        }

        // フンを描画する関数
        function drawPoop(poop) {
             ctx.drawImage(poopImage, poop.x - poopSize / 2, poop.y - poopSize / 2, poopSize, poopSize);
        }

        // フンを生成する関数
        function createPoop() {
            poops.push({ x: dogX, y: dogY });
        }

        // ゲームの状態を更新する関数
        function updateGame() {
            // 部屋の境界チェックと犬の移動
            dogX += dogSpeedX;
            dogY += dogSpeedY;
            if (dogX < 0 || dogX > roomWidth) dogSpeedX *= -1;
            if (dogY < 0 || dogY > roomHeight) dogSpeedY *= -1;
            
            // ランダムに方向転換（壁にぶつかっていない時も）
            if (Math.random() < 0.005) { // 0.5%の確率で方向転換
                const currentSpeed = Math.sqrt(dogSpeedX * dogSpeedX + dogSpeedY * dogSpeedY);
                const newAngle = Math.random() * 2 * Math.PI;
                dogSpeedX = Math.cos(newAngle) * currentSpeed;
                dogSpeedY = Math.sin(newAngle) * currentSpeed;
            }

            // プレイヤーの移動
            const dx = targetX - playerX;
            const dy = targetY - playerY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance > 1) {
                const moveX = (dx / distance) * playerSpeed;
                const moveY = (dy / distance) * playerSpeed;
                playerX += moveX;
                playerY += moveY;
            }

            // 一定間隔でフンを生成
            if (Math.random() < 0.01) {
                createPoop();
            }

           // プレイヤーとフンの衝突判定と処理
            for (let i = poops.length - 1; i >= 0; i--) {
                const poop = poops[i];
                const px = playerX;
                const py = playerY;
                const poopX = poop.x;
                const poopY = poop.y;
                const combinedRadius = playerSize / 2 + poopSize / 2;

                if (Math.abs(px - poopX) < combinedRadius && Math.abs(py - poopY) < combinedRadius) {
                    poops.splice(i, 1); // フンを削除
                    score += 10; // スコアを10点加算
                    
                    // スコアが100の倍数を超えるたびに犬のスピードを上げる
                    const currentMilestone = Math.floor(score / 100) * 100;
                    if (currentMilestone > lastSpeedIncrease && currentMilestone > 0) {
                        // スピードを1.2倍に増加（最大スピード制限付き）
                        const maxSpeed = 5.0; // 最大スピード制限
                        dogSpeedX = Math.sign(dogSpeedX) * Math.min(Math.abs(dogSpeedX) * 1.2, maxSpeed);
                        dogSpeedY = Math.sign(dogSpeedY) * Math.min(Math.abs(dogSpeedY) * 1.2, maxSpeed);
                        lastSpeedIncrease = currentMilestone;
                    }
                }
            }
        }

        // スコアを描画する関数
        function drawScore() {
            ctx.fillStyle = 'black';
            ctx.font = '20px Arial';
            ctx.textAlign = 'right';
            ctx.fillText(`SCORE: ${score}`, roomWidth - 10, 30);
        }

        // 描画処理を行う関数
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPlayer();
            drawDog();
            poops.forEach(drawPoop);
            drawScore();
        }

        // ゲームループ
        function gameLoop() {
            updateGame();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // クリックイベントでプレイヤーの目標地点を設定
        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            targetX = (event.clientX - rect.left) * scaleX;
            targetY = (event.clientY - rect.top) * scaleY;
        });

        // 画像がロードされた後にゲームを開始
        let imagesLoaded = 0;
        const totalImages = 3; // プレイヤー、犬、フンの画像

        const imageLoaded = () => {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
                gameLoop(); // 全ての画像がロードされたらゲームを開始
            }
        };

        playerImage.onload = imageLoaded;
        dogImage.onload = imageLoaded;
        poopImage.onload = imageLoaded;

        playerImage.src = playerImageURL;
        dogImage.src = dogImageURL;
        poopImage.src = poopImageURL;
    </script>
</body>
</html>
